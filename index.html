<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DBC Scan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./assets/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ink: "#1c1a16",
              tomato: "#e1523a",
              saffron: "#f3b247",
              mint: "#3fb389",
              cream: "#f8f1e6",
              sky: "#e9f0f4",
              slate: "#3f3d3b"
            },
            fontFamily: {
              display: ["Space Grotesk", "sans-serif"],
              body: ["Space Grotesk", "sans-serif"]
            }
          }
        }
      };
    </script>
  </head>
  <body class="font-body bg-cream text-ink">
    <div class="page-wrap flex min-h-screen flex-col px-5 pb-10 pt-8">
      <header class="relative z-10">
        <p class="text-xs uppercase tracking-[0.2em] text-slate">DBC</p>
        <h1 class="mt-2 text-2xl font-bold">Scan Barcode</h1>
        <p class="mt-2 text-sm text-slate">Masukkan kode unik dari meja atau takeaway.</p>
      </header>

      <section class="relative z-10 mt-6">
        <div class="surface shadow-soft rounded-2xl p-5">
          <div class="grid gap-3">
            <p class="text-sm font-semibold">Scan dengan kamera</p>
            <div class="rounded-2xl border border-ink/10 bg-white p-3">
              <video id="cameraPreview" class="h-48 w-full rounded-xl object-cover" autoplay muted playsinline></video>
            </div>
            <div class="flex gap-2">
              <button id="startScan" class="flex-1 rounded-full bg-ink px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-cream">Start</button>
              <button id="stopScan" class="flex-1 rounded-full border border-ink/10 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-ink">Stop</button>
            </div>
            <p id="scanStatus" class="text-xs text-slate">Izinkan kamera untuk memulai scan.</p>
          </div>
          <div class="my-4 h-px bg-ink/10"></div>
          <label class="grid gap-2 text-sm font-semibold">
            Kode Session
            <input id="sessionInput" class="rounded-full border border-ink/10 bg-white px-4 py-3 text-sm" type="text" placeholder="Contoh: FO-2504" />
          </label>
          <button id="scanButton" class="mt-4 inline-flex w-full items-center justify-center gap-2 rounded-full bg-ink px-4 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-cream">
            <svg aria-hidden="true" class="h-4 w-4" viewBox="0 0 24 24" fill="none">
              <path d="M5 12h14M13 6l6 6-6 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Scan & Masuk
          </button>
          <p class="mt-3 text-xs text-slate">Simulasi scan: ketik kode lalu tekan tombol.</p>
        </div>
      </section>

      <footer class="relative z-10 mt-auto pt-10 text-xs text-slate">DBC Customer</footer>
    </div>

    <script>
      const input = document.getElementById("sessionInput");
      const button = document.getElementById("scanButton");
      const cameraPreview = document.getElementById("cameraPreview");
      const startScan = document.getElementById("startScan");
      const stopScan = document.getElementById("stopScan");
      const scanStatus = document.getElementById("scanStatus");
      let stream = null;
      let scanning = false;
      let detector = null;

      function goToSession() {
        const code = (input.value || "").trim();
        if (!code) return;
        window.location.href = `./customer/index.html?session=${encodeURIComponent(code)}`;
      }

      async function initScanner() {
        if (!("BarcodeDetector" in window)) {
          scanStatus.textContent = "Browser belum mendukung scan kamera. Gunakan input manual.";
          return;
        }
        detector = new BarcodeDetector({ formats: ["qr_code", "code_128", "code_39", "ean_13"] });
      }

      async function startCamera() {
        if (!detector) {
          await initScanner();
        }
        if (!detector) return;
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          cameraPreview.srcObject = stream;
          scanning = true;
          scanStatus.textContent = "Arahkan kamera ke barcode/QR.";
          scanLoop();
        } catch (error) {
          scanStatus.textContent = "Tidak bisa akses kamera. Coba input manual.";
        }
      }

      function stopCamera() {
        scanning = false;
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        cameraPreview.srcObject = null;
        scanStatus.textContent = "Scan dihentikan.";
      }

      async function scanLoop() {
        if (!scanning || !detector) return;
        try {
          const results = await detector.detect(cameraPreview);
          if (results.length > 0) {
            const code = results[0].rawValue;
            input.value = code;
            scanStatus.textContent = `Terdeteksi: ${code}`;
            stopCamera();
            goToSession();
            return;
          }
        } catch (error) {
          scanStatus.textContent = "Gagal membaca kode. Coba lagi.";
        }
        requestAnimationFrame(scanLoop);
      }

      button?.addEventListener("click", goToSession);
      input?.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          goToSession();
        }
      });
      startScan?.addEventListener("click", startCamera);
      stopScan?.addEventListener("click", stopCamera);
      initScanner();
    </script>
  </body>
</html>
